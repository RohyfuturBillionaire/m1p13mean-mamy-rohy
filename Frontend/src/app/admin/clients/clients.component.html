<div class="clients-page">
  <!-- Header -->
  <div class="page-header">
    <div class="header-left">
      <h1>Gestion des Clients</h1>
      <p>G√©rez les utilisateurs et leurs r√¥les</p>
    </div>
    <!-- <button class="btn btn-primary" (click)="openAddModal()">
      <span>+</span>
      Nouveau Client
    </button> -->
  </div>

  <!-- Stats Cards -->
  <div class="stats-row">
    <div class="stat-card">
      <span class="stat-icon">üë•</span>
      <div class="stat-content">
        <span class="stat-value">{{ getStats().total }}</span>
        <span class="stat-label">Total Utilisateurs</span>
      </div>
    </div>
    <div class="stat-card">
      <span class="stat-icon">üë§</span>
      <div class="stat-content">
        <span class="stat-value">{{ getStats().clients }}</span>
        <span class="stat-label">Clients</span>
      </div>
    </div>
    <div class="stat-card">
      <span class="stat-icon">üè™</span>
      <div class="stat-content">
        <span class="stat-value">{{ getStats().boutiques }}</span>
        <span class="stat-label">Boutiques</span>
      </div>
    </div>
    <div class="stat-card">
      <span class="stat-icon">‚úÖ</span>
      <div class="stat-content">
        <span class="stat-value">{{ getStats().Nouveaux }}</span>
        <span class="stat-label">Nouveaux Inscrits</span>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-bar">
    <div class="search-box">
      <span class="search-icon">üîç</span>
      <input
        type="text"
        placeholder="Rechercher par nom, email..."
        [value]="searchQuery()"
        (input)="onSearchChange($event)"
      >
    </div>
    <div class="filter-tabs">
      <button
        class="filter-tab"
        [class.active]="roleFilter() === 'all'"
        (click)="onRoleFilterChange('all')"
      >
        Tous
      </button>
      @for (role of roles(); track role._id) {
        <button
          class="filter-tab"
          [class.active]="roleFilter() === role.role_name"
          (click)="onRoleFilterChange(role.role_name)"
        >
          {{ role.role_name | titlecase }}
        </button>
      }
    </div>
  </div>

  <!-- Users Table -->
  <div class="table-card">
    <table class="data-table">
      <thead>
        <tr>
          <th>Utilisateur</th>
          <th>Email</th>
          <!-- <th>T√©l√©phone</th> -->
          <th>R√¥le</th>
          <th>Inscription</th>
          <!-- <th>Statut</th> -->
          <th>Actions</th>
          <th>liaison</th>
        </tr>
      </thead>
      <tbody>
        @for (user of filteredUsers(); track user._id) {
          <tr>
            <td>
              <div class="user-cell">
                <!-- <div class="user-avatar" [class.has-image]="user.avatar"> -->
                <div class="user-avatar" >

                  <!-- @if (user.avatar) {
                    <img [src]="user.avatar" [alt]="user.nom">
                  } @else { -->
                    {{ user.username.split(' ')[0] === undefined ? '' : user.username.split(' ')[0].charAt(0) }}{{ user.username.split(' ')[1] === undefined ? '' : user.username.split(' ')[1].charAt(0) }}
                  <!-- } -->
                </div>
                <div class="user-info">
                  <!-- <span class="user-name">{{ user.username.split(' ')[0] }} {{ user.username.split(' ')[1] }}</span>4 -->
                   <span class="user-name">{{ user.username}} </span>
                </div>
              </div>
            </td>
            <td>{{ user.email }}</td>
            <!-- <td>{{ user.telephone }}</td> -->
            <td>
              <select
                class="role-select"
                [class]="getRoleClass(getRoleName(user))"
                [ngModel]="getRoleName(user)"
                (ngModelChange)="changeUserRole(user, $event)"
              >
              <option [ngValue]="'admin'">Admin</option>
                @for (role of roles(); track role._id) {
                  <option [ngValue]="role.role_name">{{ role.role_name | titlecase }}</option>
                }
              </select>
            </td>
            <td>{{ formatDate(user.createdAt!) }}</td>
            <!-- <td>
              <button
                class="status-toggle"
                [class.active]="user.actif"
                (click)="toggleUserStatus(user)"
              >
                <span class="toggle-track">
                  <span class="toggle-thumb"></span>
                </span>
                <span class="toggle-label">{{ user.actif ? 'Actif' : 'Inactif' }}</span>
              </button>
            </td> -->
            <td>
              <div class="actions">
                <button class="action-btn edit" title="Modifier" (click)="openEditModal(user)">
                  ‚úèÔ∏è
                </button>
                <button class="action-btn delete" title="Supprimer" (click)="confirmDelete(user)">
                  üóëÔ∏è
                </button>
              </div>
            </td>
            <td>
              <button class="action-btn link" *ngIf="isShop(user)" (click)="openLinkBoutiqueModal(user)" title="Lier √† une boutique">
                üîó
              </button>
            </td>
          </tr>
        }
      </tbody>
    </table>

    @if (filteredUsers().length === 0) {
      <div class="empty-state">
        <span>üë§</span>
        <p>Aucun utilisateur trouv√©</p>
      </div>
    }
  </div>
</div>

<!-- Add/Edit Modal -->
@if (showModal()) {
  <div class="modal-overlay" (click)="closeModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ editMode() ? 'Modifier' : 'Ajouter' }} un utilisateur</h2>
        <button class="close-btn" (click)="closeModal()">‚úï</button>
      </div>
      <div class="modal-body">
       <div class="form-row">
          <div class="form-group">
            <label>Pr√©nom</label>
            <input
              type="text"
              [(ngModel)]="currentUser.prenom"
              placeholder="Pr√©nom"
            >
          </div>
          <div class="form-group">
            <label>Nom</label>
            <input
              type="text"
              [(ngModel)]="currentUser.nom"
              placeholder="Nom"
            >
          </div>
        </div>

        <div class="form-group">
          <label>Email</label>
          <input
            type="email"
            [(ngModel)]="currentUser.email"
            placeholder="email@exemple.com"
          >
        </div>
        <!-- <div class="form-group">
          <label>T√©l√©phone</label>
          <input
            type="tel"
            [(ngModel)]="currentUser.telephone"
            placeholder="+261 xx xxx xx"
          >
        </div> -->
        <div class="form-row">
          <div class="form-group">
            <label>R√¥le</label>
            <select [(ngModel)]="currentUser.id_role">
              @for (role of roles(); track role._id) {
                <option [ngValue]="role._id">{{ role.role_name | titlecase }}</option>
              }
            </select>
          </div>
          <!-- <div class="form-group">
            <label>Statut</label>
            <select [(ngModel)]="currentUser.actif">
              <option [ngValue]="true">Actif</option>
              <option [ngValue]="false">Inactif</option>
            </select>
          </div> -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" (click)="closeModal()">Annuler</button>
        <button class="btn btn-primary" (click)="saveUser()">
          {{ editMode() ? 'Mettre √† jour' : 'Ajouter' }}
        </button>
      </div>
    </div>
  </div>
}

<!-- Delete Confirmation Modal -->
@if (showDeleteConfirm()) {
  <div class="modal-overlay" (click)="cancelDelete()">
    <div class="modal confirm-modal" (click)="$event.stopPropagation()">
      <div class="modal-body">
        <span class="confirm-icon">‚ö†Ô∏è</span>
        <h3>Confirmer la suppression</h3>
        <p>√ätes-vous s√ªr de vouloir supprimer l'utilisateur <strong>{{ userToDelete()?.username }} </strong> ?</p>
        <p class="warning-text">Cette action est irr√©versible.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" (click)="cancelDelete()">Annuler</button>
        <button class="btn btn-danger" (click)="deleteUser()">Supprimer</button>
      </div>
    </div>
  </div>
}

<!-- Link Boutique Modal -->
@if (showLinkBoutiqueModal()) {
  <div class="modal-overlay" (click)="closeLinkBoutiqueModal()">
    <div class="modal link-boutique-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Lier une boutique</h2>
        <button class="close-btn" (click)="closeLinkBoutiqueModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <p class="link-info">
          Lier l'utilisateur <strong>{{ selectedUserForLink()?.username }}</strong> √† une boutique
        </p>
        
        @if (unlinkedBoutiques().length === 0) {
          <div class="empty-state">
            <span>üè™</span>
            <p>Aucune boutique disponible</p>
            <p class="sub-text">Toutes les boutiques sont d√©j√† li√©es √† un utilisateur</p>
          </div>
        } @else {
          <div class="boutiques-list">
            @for (boutique of unlinkedBoutiques(); track boutique._id) {
              <div 
                class="boutique-item" 
                [class.selected]="selectedBoutiqueId() === boutique._id"
                (click)="selectedBoutiqueId.set(boutique._id)"
              >
                <div class="boutique-logo">
                  @if (boutique.logo) {
                    <img [src]="'http://localhost:5000' + boutique.logo" [alt]="boutique.nom">
                  } @else {
                    <span class="logo-placeholder">üè™</span>
                  }
                </div>
                <div class="boutique-info">
                  <span class="boutique-name">{{ boutique.nom }}</span>
                  <span class="boutique-category">{{ boutique.id_categorie?.nom || 'Non cat√©goris√©' }}</span>
                  @if (boutique.description) {
                    <span class="boutique-description">{{ boutique.description }}</span>
                  }
                </div>
                <div class="boutique-check">
                  @if (selectedBoutiqueId() === boutique._id) {
                    <span>‚úì</span>
                  }
                </div>
              </div>
            }
          </div>
        }
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" (click)="closeLinkBoutiqueModal()">Annuler</button>
        <button 
          class="btn btn-primary" 
          (click)="linkBoutique()" 
          [disabled]="!selectedBoutiqueId()"
        >
          Lier la boutique
        </button>
      </div>
    </div>
  </div>
}
