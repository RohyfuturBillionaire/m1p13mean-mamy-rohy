<div class="clients-page">
  <!-- Header -->
  <div class="page-header">
    <div class="header-left">
      <h1>Gestion des Clients</h1>
      <p>Gérez les utilisateurs et leurs rôles</p>
    </div>
    <button class="btn btn-primary" (click)="openAddModal()">
      <span>+</span>
      Nouveau Client
    </button>
  </div>

  <!-- Stats Cards -->
  <div class="stats-row">
    <div class="stat-card">
      <span class="stat-icon"><span class="material-icons">group</span></span>
      <div class="stat-content">
        <span class="stat-value">{{ getStats().total }}</span>
        <span class="stat-label">Total Utilisateurs</span>
      </div>
    </div>
    <div class="stat-card">
      <span class="stat-icon"><span class="material-icons">person</span></span>
      <div class="stat-content">
        <span class="stat-value">{{ getStats().clients }}</span>
        <span class="stat-label">Clients</span>
      </div>
    </div>
    <div class="stat-card">
      <span class="stat-icon"><span class="material-icons">store</span></span>
      <div class="stat-content">
        <span class="stat-value">{{ getStats().boutiques }}</span>
        <span class="stat-label">Boutiques</span>
      </div>
    </div>
    <div class="stat-card">
      <span class="stat-icon"><span class="material-icons">check_circle</span></span>
      <div class="stat-content">
        <span class="stat-value">{{ getStats().actifs }}</span>
        <span class="stat-label">Actifs</span>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-bar">
    <div class="search-box">
      <span class="search-icon"><span class="material-icons">search</span></span>
      <input
        type="text"
        placeholder="Rechercher par nom, email..."
        [value]="searchQuery()"
        (input)="onSearchChange($event)"
      >
    </div>
    <div class="filter-tabs">
      <button
        class="filter-tab"
        [class.active]="roleFilter() === 'all'"
        (click)="onRoleFilterChange('all')"
      >
        Tous
      </button>
      <button
        class="filter-tab"
        [class.active]="roleFilter() === 'client'"
        (click)="onRoleFilterChange('client')"
      >
        Clients
      </button>
      <button
        class="filter-tab"
        [class.active]="roleFilter() === 'boutique'"
        (click)="onRoleFilterChange('boutique')"
      >
        Boutiques
      </button>
      <button
        class="filter-tab"
        [class.active]="roleFilter() === 'admin'"
        (click)="onRoleFilterChange('admin')"
      >
        Admins
      </button>
    </div>
  </div>

  <!-- Users Table -->
  <div class="table-card">
    <table class="data-table">
      <thead>
        <tr>
          <th>Utilisateur</th>
          <th>Email</th>
          <th>Téléphone</th>
          <th>Rôle</th>
          <th>Inscription</th>
          <th>Statut</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        @for (user of filteredUsers(); track user.id) {
          <tr>
            <td>
              <div class="user-cell">
                <div class="user-avatar" [class.has-image]="user.avatar">
                  @if (user.avatar) {
                    <img [src]="user.avatar" [alt]="user.nom">
                  } @else {
                    {{ user.prenom[0] }}{{ user.nom[0] }}
                  }
                </div>
                <div class="user-info">
                  <span class="user-name">{{ user.prenom }} {{ user.nom }}</span>
                </div>
              </div>
            </td>
            <td>{{ user.email }}</td>
            <td>{{ user.telephone }}</td>
            <td>
              <select
                class="role-select"
                [class]="getRoleClass(user.role)"
                [value]="user.role"
                (change)="changeUserRole(user, $any($event.target).value)"
              >
                <option value="client">Client</option>
                <option value="boutique">Boutique</option>
                <option value="admin">Admin</option>
              </select>
            </td>
            <td>{{ formatDate(user.dateInscription) }}</td>
            <td>
              <button
                class="status-toggle"
                [class.active]="user.actif"
                (click)="toggleUserStatus(user)"
              >
                <span class="toggle-track">
                  <span class="toggle-thumb"></span>
                </span>
                <span class="toggle-label">{{ user.actif ? 'Actif' : 'Inactif' }}</span>
              </button>
            </td>
            <td>
              <div class="actions">
                <button class="action-btn edit" title="Modifier" (click)="openEditModal(user)">
                  <span class="material-icons">edit</span>
                </button>
                <button class="action-btn delete" title="Supprimer" (click)="confirmDelete(user)">
                  <span class="material-icons">delete</span>
                </button>
              </div>
            </td>
          </tr>
        }
      </tbody>
    </table>

    @if (filteredUsers().length === 0) {
      <div class="empty-state">
        <span class="material-icons" style="font-size: 2.5rem; color: #CBD5E1;">person_off</span>
        <p>Aucun utilisateur trouvé</p>
      </div>
    }
  </div>
</div>

<!-- Add/Edit Modal -->
@if (showModal()) {
  <div class="modal-overlay" (click)="closeModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ editMode() ? 'Modifier' : 'Ajouter' }} un utilisateur</h2>
        <button class="close-btn" (click)="closeModal()"><span class="material-icons">close</span></button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group">
            <label>Prénom</label>
            <input
              type="text"
              [(ngModel)]="currentUser.prenom"
              placeholder="Prénom"
            >
          </div>
          <div class="form-group">
            <label>Nom</label>
            <input
              type="text"
              [(ngModel)]="currentUser.nom"
              placeholder="Nom"
            >
          </div>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input
            type="email"
            [(ngModel)]="currentUser.email"
            placeholder="email@exemple.com"
          >
        </div>
        <div class="form-group">
          <label>Téléphone</label>
          <input
            type="tel"
            [(ngModel)]="currentUser.telephone"
            placeholder="+261 xx xxx xx"
          >
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Rôle</label>
            <select [(ngModel)]="currentUser.role">
              <option value="client">Client</option>
              <option value="boutique">Boutique</option>
              <option value="admin">Administrateur</option>
            </select>
          </div>
          <div class="form-group">
            <label>Statut</label>
            <select [(ngModel)]="currentUser.actif">
              <option [ngValue]="true">Actif</option>
              <option [ngValue]="false">Inactif</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" (click)="closeModal()">Annuler</button>
        <button class="btn btn-primary" (click)="saveUser()">
          {{ editMode() ? 'Mettre à jour' : 'Ajouter' }}
        </button>
      </div>
    </div>
  </div>
}

<!-- Delete Confirmation Modal -->
@if (showDeleteConfirm()) {
  <div class="modal-overlay" (click)="cancelDelete()">
    <div class="modal confirm-modal" (click)="$event.stopPropagation()">
      <div class="modal-body">
        <span class="confirm-icon"><span class="material-icons" style="font-size: 3rem; color: #F59E0B;">warning</span></span>
        <h3>Confirmer la suppression</h3>
        <p>Êtes-vous sûr de vouloir supprimer l'utilisateur <strong>{{ userToDelete()?.prenom }} {{ userToDelete()?.nom }}</strong> ?</p>
        <p class="warning-text">Cette action est irréversible.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" (click)="cancelDelete()">Annuler</button>
        <button class="btn btn-danger" (click)="deleteUser()">Supprimer</button>
      </div>
    </div>
  </div>
}
