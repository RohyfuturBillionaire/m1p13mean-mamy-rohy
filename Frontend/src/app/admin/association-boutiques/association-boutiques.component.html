<div class="association-page">
  <div class="page-header">
    <div>
      <h1>Association Boutiques - Utilisateurs</h1>
      <p>Gerez les proprietaires des boutiques (utilisateurs role Boutique uniquement)</p>
    </div>
  </div>

  <!-- Stats -->
  <div class="stats-row">
    <div class="stat-card">
      <span class="material-icons stat-icon">people</span>
      <div class="stat-info">
        <span class="stat-value">{{ getStats().total }}</span>
        <span class="stat-label">Utilisateurs boutique</span>
      </div>
    </div>
    <div class="stat-card assigned">
      <span class="material-icons stat-icon">link</span>
      <div class="stat-info">
        <span class="stat-value">{{ getStats().assigned }}</span>
        <span class="stat-label">Avec boutique</span>
      </div>
    </div>
    <div class="stat-card unassigned">
      <span class="material-icons stat-icon">link_off</span>
      <div class="stat-info">
        <span class="stat-value">{{ getStats().unassigned }}</span>
        <span class="stat-label">Sans boutique</span>
      </div>
    </div>
  </div>

  <!-- Search -->
  <div class="search-bar">
    <span class="material-icons search-icon">search</span>
    <input
      type="text"
      placeholder="Rechercher par nom d'utilisateur..."
      (input)="onSearchInput($event)"
    />
  </div>

  <!-- Table -->
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Utilisateur</th>
          <th>Email</th>
          <th>Boutique associee</th>
          <th>Statut</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        @for (user of users(); track user._id) {
          <tr>
            <td>
              <div class="user-cell">
                <span class="material-icons user-avatar">person</span>
                <strong>{{ user.username }}</strong>
              </div>
            </td>
            <td>{{ user.email }}</td>
            <td>
              @if (hasBoutique(user)) {
                <div class="boutique-cell">
                  <span class="material-icons boutique-icon">store</span>
                  <strong>{{ user.boutique?.boutiqueNom }}</strong>
                </div>
              } @else {
                <span class="no-boutique">Non assigne</span>
              }
            </td>
            <td>
              <span class="status-badge" [class.active]="hasBoutique(user)" [class.inactive]="!hasBoutique(user)">
                {{ hasBoutique(user) ? 'Associe' : 'En attente' }}
              </span>
            </td>
            <td>
              <div class="actions">
                @if (hasBoutique(user)) {
                  <button class="btn-action danger" (click)="unassignUser(user)" title="Desassigner">
                    <span class="material-icons">link_off</span>
                  </button>
                } @else {
                  <button class="btn-action primary" (click)="openAssignModal(user)" title="Assigner une boutique">
                    <span class="material-icons">add_business</span>
                  </button>
                }
              </div>
            </td>
          </tr>
        }
      </tbody>
    </table>

    @if (users().length === 0) {
      <div class="empty-state">
        <span class="material-icons">people_outline</span>
        <p>Aucun utilisateur boutique trouve</p>
      </div>
    }
  </div>
</div>

<!-- Assign Modal -->
@if (showAssignModal()) {
  <div class="modal-overlay" (click)="closeAssignModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Assigner une boutique</h2>
        <button class="close-btn" (click)="closeAssignModal()">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="modal-body">
        <p class="modal-info">
          Assigner une boutique a <strong>{{ selectedUser()?.username }}</strong> ({{ selectedUser()?.email }})
        </p>
        <div class="form-group">
          <label>Boutique disponible</label>
          <select [(ngModel)]="selectedBoutiqueId" (ngModelChange)="selectedBoutiqueId.set($event)">
            <option value="">Selectionner une boutique</option>
            @for (boutique of getUnassignedBoutiques(); track boutique._id) {
              <option [value]="boutique._id">{{ boutique.nom }} ({{ boutique.id_categorie?.nom || 'Sans categorie' }})</option>
            }
          </select>
        </div>
        @if (getUnassignedBoutiques().length === 0) {
          <p class="warning-text">
            <span class="material-icons" style="font-size: 1rem; vertical-align: middle; margin-right: 4px;">warning</span>
            Aucune boutique disponible (toutes sont deja assignees).
          </p>
        }
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" (click)="closeAssignModal()">Annuler</button>
        <button
          class="btn btn-primary"
          (click)="assignUser()"
          [disabled]="!selectedBoutiqueId() || saving()"
        >
          @if (saving()) {
            Enregistrement...
          } @else {
            <span class="material-icons" style="font-size: 1rem; vertical-align: middle; margin-right: 4px;">link</span> Assigner
          }
        </button>
      </div>
    </div>
  </div>
}
