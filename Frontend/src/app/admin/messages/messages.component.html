<div class="messages-page">
  <div class="messages-container">
    <!-- Conversations List -->
    <aside class="conversations-panel">
      <div class="panel-header">
        <h2>Messages</h2>
        <button class="icon-btn" title="Nouvel email" (click)="openEmailModal()">
          <span class="material-icons">mail</span>
        </button>
      </div>

      <div class="search-box">
        <span class="material-icons">search</span>
        <input
          type="text"
          placeholder="Rechercher..."
          [(ngModel)]="searchQuery"
        >
      </div>

      <div class="conversations-list">
        @for (conv of getFilteredConversations(); track conv.id) {
          <button
            class="conversation-item"
            [class.active]="selectedConversation()?.id === conv.id"
            [class.unread]="conv.nonLus > 0"
            (click)="selectConversation(conv)"
          >
            <div class="conv-avatar">
              @if (getOtherParticipant(conv)?.avatar) {
                <img [src]="getOtherParticipant(conv)?.avatar" [alt]="getOtherParticipant(conv)?.nom">
              } @else {
                <span class="material-icons">{{ getRoleIcon(getOtherParticipant(conv)?.role || 'client') }}</span>
              }
            </div>
            <div class="conv-content">
              <div class="conv-header">
                <span class="conv-name">{{ getOtherParticipant(conv)?.nom }}</span>
                <span class="conv-time">{{ formatTime(conv.dateModification) }}</span>
              </div>
              <p class="conv-preview">{{ conv.dernierMessage }}</p>
            </div>
            @if (conv.nonLus > 0) {
              <span class="unread-badge">{{ conv.nonLus }}</span>
            }
          </button>
        }

        @if (getFilteredConversations().length === 0) {
          <div class="empty-conversations">
            <span class="material-icons" style="font-size: 2.5rem; color: #CBD5E1;">forum</span>
            <p>Aucune conversation</p>
            <button class="btn btn-primary" (click)="openNewConversationModal()">
              ➕ Nouvelle conversation
            </button>
          </div>
        } @else {
          @for (conv of getFilteredConversations(); track conv._id) {
            <button
              class="conversation-item"
              [class.active]="selectedConversation()?._id === conv._id"
              (click)="selectConversation(conv)"
            >
              <div class="conv-avatar">
                <span>{{ getInitials(getOtherParticipant(conv)) }}</span>
              </div>
              <div class="conv-content">
                <div class="conv-header">
                  <span class="conv-name">{{ getOtherParticipant(conv)?.username || 'Utilisateur' }}</span>
                  <span class="conv-time">{{ formatTime(conv.updatedAt) }}</span>
                </div>
                <p class="conv-preview">{{ getLastMessage(conv._id) }}</p>
              </div>
            </button>
          }
        }
      </div>
    </aside>

    <!-- Chat Panel -->
    <main class="chat-panel">
      @if (selectedConversation()) {
        <!-- Chat Header -->
        <div class="chat-header">
          <div class="chat-user">
            <div class="chat-avatar">
              @if (getOtherParticipant(selectedConversation()!)?.avatar) {
                <img [src]="getOtherParticipant(selectedConversation()!)?.avatar" alt="">
              } @else {
                <span class="material-icons">{{ getRoleIcon(getOtherParticipant(selectedConversation()!)?.role || 'client') }}</span>
              }
            </div>
            <div class="chat-info">
              <span class="chat-name">{{ getOtherParticipant(selectedConversation()!)?.username }}</span>
              <span class="chat-role">{{ getRoleName(getOtherParticipant(selectedConversation()!)) | titlecase }}</span>
            </div>
          </div>
          <div class="chat-actions">
            <button class="icon-btn" title="Appeler"><span class="material-icons">phone</span></button>
            <button class="icon-btn" title="Email" (click)="openEmailModal()"><span class="material-icons">mail</span></button>
            <button class="icon-btn" title="Plus"><span class="material-icons">more_vert</span></button>
          </div>
        </div>

        <!-- Messages -->
        <div class="messages-list">
          @for (msg of messages(); track msg._id) {
            <div class="message" [class.own]="isOwnMessage(msg)">
              <div class="message-bubble">
                <p>{{ msg.message }}</p>
                <span class="message-time">{{ formatMessageTime(msg.date_envoie) }}</span>
              </div>
            </div>
          }
          @if (messages().length === 0) {
            <div class="empty-messages">
              <p>Aucun message. Commencez la conversation!</p>
            </div>
          }
        </div>

        <!-- Input -->
        <div class="chat-input">
          <button class="attach-btn" title="Joindre un fichier"><span class="material-icons">attach_file</span></button>
          <input
            type="text"
            placeholder="Écrivez votre message..."
            [(ngModel)]="newMessage"
            (keyup.enter)="sendMessage()"
          >
          <button class="send-btn" (click)="sendMessage()" [disabled]="!newMessage()">
            <span class="material-icons">send</span>
          </button>
        </div>
      } @else {
        <!-- No Conversation Selected -->
        <div class="no-conversation">
          <span class="material-icons" style="font-size: 3rem; color: #CBD5E1;">forum</span>
          <h3>Sélectionnez une conversation</h3>
          <p>Choisissez une conversation dans la liste ou envoyez un nouvel email</p>
          <button class="btn btn-primary" (click)="openEmailModal()">
            <span class="material-icons">mail</span> Envoyer un email
          </button>
        </div>
      }
    </main>
  </div>
</div>

<!-- New Conversation Modal -->
@if (showNewConversationModal()) {
  <div class="modal-overlay" (click)="closeNewConversationModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Envoyer un Email</h2>
        <button class="close-btn" (click)="closeEmailModal()"><span class="material-icons">close</span></button>
      </div>
      <div class="modal-body">
        <p>Sélectionnez une boutique pour démarrer une conversation:</p>
        <div class="user-list">
          @if (boutiqueUsers().length === 0) {
            <div class="empty-users">
              <p>Aucune boutique disponible</p>
            </div>
          } @else {
            @for (user of boutiqueUsers(); track user._id) {
              <button class="user-item" (click)="startConversation(user)">
                <div class="user-avatar">
                  <span>{{ getInitials(user) }}</span>
                </div>
                <div class="user-info">
                  <span class="user-name">{{ user.username }}</span>
                  <span class="user-email">{{ user.email }}</span>
                </div>
              </button>
            }
          }
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" (click)="closeEmailModal()">Annuler</button>
        <button class="btn btn-primary" (click)="sendEmail()">
          <span class="material-icons">send</span> Envoyer
        </button>
      </div>
    </div>
  </div>
}
