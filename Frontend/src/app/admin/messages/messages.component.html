<div class="messages-page">
  <div class="messages-container">
    <!-- Conversations List -->
    <aside class="conversations-panel">
      <div class="panel-header">
        <h2>Messages</h2>
        <button class="icon-btn" title="Nouvelle conversation" (click)="openNewConversationModal()">
          ‚ûï
        </button>
      </div>

      <div class="search-box">
        <span>üîç</span>
        <input
          type="text"
          placeholder="Rechercher..."
          [(ngModel)]="searchQuery"
        >
      </div>

      <div class="conversations-list">
        @if (getFilteredConversations().length === 0) {
          <div class="empty-conversations">
            <span>üí¨</span>
            <p>Aucune conversation</p>
            <button class="btn btn-primary" (click)="openNewConversationModal()">
              ‚ûï Nouvelle conversation
            </button>
          </div>
        } @else {
          @for (conv of getFilteredConversations(); track conv._id) {
            <button
              class="conversation-item"
              [class.active]="selectedConversation()?._id === conv._id"
              (click)="selectConversation(conv)"
            >
              <div class="conv-avatar">
                <span>{{ getInitials(getOtherParticipant(conv)) }}</span>
              </div>
              <div class="conv-content">
                <div class="conv-header">
                  <span class="conv-name">{{ getOtherParticipant(conv)?.username || 'Utilisateur' }}</span>
                  <span class="conv-time">{{ formatTime(conv.updatedAt) }}</span>
                </div>
                <p class="conv-preview">{{ getRoleName(getOtherParticipant(conv)) | titlecase }}</p>
              </div>
            </button>
          }
        }
      </div>
    </aside>

    <!-- Chat Panel -->
    <main class="chat-panel">
      @if (selectedConversation()) {
        <!-- Chat Header -->
        <div class="chat-header">
          <div class="chat-user">
            <div class="chat-avatar">
              <span>{{ getInitials(getOtherParticipant(selectedConversation()!)) }}</span>
            </div>
            <div class="chat-info">
              <span class="chat-name">{{ getOtherParticipant(selectedConversation()!)?.username }}</span>
              <span class="chat-role">{{ getRoleName(getOtherParticipant(selectedConversation()!)) | titlecase }}</span>
            </div>
          </div>
          <div class="chat-actions">
            <button class="icon-btn" title="Plus">‚ãÆ</button>
          </div>
        </div>

        <!-- Messages -->
        <div class="messages-list">
          @for (msg of messages(); track msg._id) {
            <div class="message" [class.own]="isOwnMessage(msg)">
              <div class="message-bubble">
                <p>{{ msg.message }}</p>
                <span class="message-time">{{ formatMessageTime(msg.date_envoie) }}</span>
              </div>
            </div>
          }
          @if (messages().length === 0) {
            <div class="empty-messages">
              <p>Aucun message. Commencez la conversation!</p>
            </div>
          }
        </div>

        <!-- Input -->
        <div class="chat-input">
          <input
            type="text"
            placeholder="√âcrivez votre message..."
            [(ngModel)]="newMessage"
            (keyup.enter)="sendMessage()"
          >
          <button class="send-btn" (click)="sendMessage()" [disabled]="!newMessage()">
            ‚û§
          </button>
        </div>
      } @else {
        <!-- No Conversation Selected -->
        <div class="no-conversation">
          <span>üí¨</span>
          <h3>S√©lectionnez une conversation</h3>
          <p>Choisissez une conversation dans la liste ou cr√©ez une nouvelle conversation</p>
          <button class="btn btn-primary" (click)="openNewConversationModal()">
            ‚ûï Nouvelle conversation
          </button>
        </div>
      }
    </main>
  </div>
</div>

<!-- New Conversation Modal -->
@if (showNewConversationModal()) {
  <div class="modal-overlay" (click)="closeNewConversationModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Nouvelle conversation</h2>
        <button class="close-btn" (click)="closeNewConversationModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <p>S√©lectionnez une boutique pour d√©marrer une conversation:</p>
        <div class="user-list">
          @if (boutiqueUsers().length === 0) {
            <div class="empty-users">
              <p>Aucune boutique disponible</p>
            </div>
          } @else {
            @for (user of boutiqueUsers(); track user._id) {
              <button class="user-item" (click)="startConversation(user)">
                <div class="user-avatar">
                  <span>{{ getInitials(user) }}</span>
                </div>
                <div class="user-info">
                  <span class="user-name">{{ user.username }}</span>
                  <span class="user-email">{{ user.email }}</span>
                </div>
              </button>
            }
          }
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" (click)="closeNewConversationModal()">Annuler</button>
      </div>
    </div>
  </div>
}
