<div class="stocks-page">
  <div class="page-header">
    <div>
      <h1>Gestion des Stocks</h1>
      <p>Gérez les stocks de vos produits</p>
    </div>
  </div>

  <!-- Alerts -->
  @if (alerts().outOfStock.length > 0 || alerts().lowStock.length > 0) {
    <div class="alerts-section">
      @if (alerts().outOfStock.length > 0) {
        <div class="alert-card danger">
          <span class="material-icons">error</span>
          <div class="alert-content">
            <strong>{{ alerts().outOfStock.length }} produit(s) en rupture</strong>
            <span>{{ getOutOfStockNames() }}</span>
          </div>
        </div>
      }
      @if (alerts().lowStock.length > 0) {
        <div class="alert-card warning">
          <span class="material-icons">warning</span>
          <div class="alert-content">
            <strong>{{ alerts().lowStock.length }} produit(s) en stock faible</strong>
            <span>{{ getLowStockNames() }}</span>
          </div>
        </div>
      }
    </div>
  }

  <div class="content-grid">
    <!-- Products Stock -->
    <div class="card">
      <div class="card-header">
        <h2>Stock par Produit</h2>
      </div>
      <div class="stock-list">
        @for (produit of produits(); track produit.id) {
          <div class="stock-item" [class]="getStockClass(produit)">
            <div class="stock-product">
              <img [src]="produit.image" [alt]="produit.nom">
              <div class="product-info">
                <span class="product-name">{{ produit.nom }}</span>
                <span class="product-category">{{ produit.categorie }}</span>
              </div>
            </div>
            <div class="stock-data">
              <div class="stock-value" [class]="getStockClass(produit)">
                <span class="value">{{ produit.stock }}</span>
                <span class="label">en stock</span>
              </div>
              <div class="stock-alert">
                <span class="material-icons">notifications</span>
                Alerte: {{ produit.stockAlerte }}
              </div>
            </div>
            <button class="btn btn-outline btn-sm" (click)="openModal(produit)">
              <span class="material-icons">edit</span>
              Modifier
            </button>
          </div>
        }
      </div>
    </div>

    <!-- Recent Movements -->
    <div class="card">
      <div class="card-header">
        <h2>Mouvements Récents</h2>
      </div>
      <div class="movements-list">
        @for (mouvement of mouvements(); track mouvement.id) {
          <div class="movement-item" [class]="mouvement.type">
            <div class="movement-icon">
              @if (mouvement.type === 'entree') {
                <span class="material-icons">add_circle</span>
              } @else if (mouvement.type === 'sortie') {
                <span class="material-icons">remove_circle</span>
              } @else {
                <span class="material-icons">sync</span>
              }
            </div>
            <div class="movement-info">
              <span class="movement-product">{{ mouvement.produitNom }}</span>
              <span class="movement-type">{{ getMovementLabel(mouvement.type) }}</span>
              @if (mouvement.motif) {
                <span class="movement-motif">{{ mouvement.motif }}</span>
              }
            </div>
            <div class="movement-data">
              <span class="quantity" [class]="mouvement.type">
                {{ mouvement.type === 'sortie' ? '-' : '+' }}{{ mouvement.quantite }}
              </span>
              <span class="stock-change">{{ mouvement.stockAvant }} → {{ mouvement.stockApres }}</span>
              <span class="movement-date">{{ formatDate(mouvement.date) }}</span>
            </div>
          </div>
        }
      </div>
    </div>
  </div>
</div>

<!-- Stock Movement Modal -->
@if (showModal()) {
  <div class="modal-backdrop" (click)="closeModal()"></div>
  <div class="modal">
    <div class="modal-header">
      <h2>Mouvement de Stock</h2>
      <button class="close-btn" (click)="closeModal()">
        <span class="material-icons">close</span>
      </button>
    </div>
    <div class="modal-body">
      <div class="selected-product">
        <img [src]="selectedProduit()?.image" [alt]="selectedProduit()?.nom">
        <div>
          <strong>{{ selectedProduit()?.nom }}</strong>
          <span>Stock actuel: {{ selectedProduit()?.stock }} unités</span>
        </div>
      </div>

      <div class="form-group">
        <label>Type de mouvement</label>
        <div class="radio-group">
          <label class="radio-item" [class.selected]="movementType() === 'entree'">
            <input type="radio" name="type" value="entree" [checked]="movementType() === 'entree'" (change)="movementType.set('entree')">
            <span class="material-icons">add_circle</span>
            Entrée
          </label>
          <label class="radio-item" [class.selected]="movementType() === 'sortie'">
            <input type="radio" name="type" value="sortie" [checked]="movementType() === 'sortie'" (change)="movementType.set('sortie')">
            <span class="material-icons">remove_circle</span>
            Sortie
          </label>
          <label class="radio-item" [class.selected]="movementType() === 'ajustement'">
            <input type="radio" name="type" value="ajustement" [checked]="movementType() === 'ajustement'" (change)="movementType.set('ajustement')">
            <span class="material-icons">sync</span>
            Ajustement
          </label>
        </div>
      </div>

      <div class="form-group">
        <label>{{ movementType() === 'ajustement' ? 'Nouveau stock' : 'Quantité' }}</label>
        <input type="number" [value]="quantity()" (input)="quantity.set(+$any($event.target).value)" min="0">
      </div>

      <div class="form-group">
        <label>Motif (optionnel)</label>
        <input type="text" [value]="motif()" (input)="motif.set($any($event.target).value)" placeholder="Raison du mouvement">
      </div>

      @if (movementType() !== 'ajustement') {
        <div class="preview">
          <span>Stock après mouvement:</span>
          <strong>{{ calcNewStock(movementType(), selectedProduit()?.stock || 0, quantity()) }} unités</strong>
        </div>
      }
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" (click)="closeModal()">Annuler</button>
      <button class="btn btn-primary" (click)="submitMovement()" [disabled]="isSubmitting() || quantity() <= 0">
        @if (isSubmitting()) {
          <span class="loader-sm"></span>
        }
        Valider
      </button>
    </div>
  </div>
}
