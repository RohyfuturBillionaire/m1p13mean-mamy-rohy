<div class="commandes-page">
  <div class="page-header">
    <div><h1>Gestion des Commandes</h1><p>Suivez et gérez vos commandes clients</p></div>
  </div>

  <div class="stats-grid">
    <div class="stat-card"><div class="stat-icon total"><span class="material-icons">receipt_long</span></div><div class="stat-content"><span class="stat-value">{{ stats().total }}</span><span class="stat-label">Total</span></div></div>
    <div class="stat-card"><div class="stat-icon pending"><span class="material-icons">hourglass_empty</span></div><div class="stat-content"><span class="stat-value">{{ stats().enAttente }}</span><span class="stat-label">En attente</span></div></div>
    <div class="stat-card"><div class="stat-icon paid"><span class="material-icons">payments</span></div><div class="stat-content"><span class="stat-value">{{ stats().payees }}</span><span class="stat-label">Payées</span></div></div>
    <div class="stat-card"><div class="stat-icon delivered"><span class="material-icons">check_circle</span></div><div class="stat-content"><span class="stat-value">{{ stats().livrees }}</span><span class="stat-label">Livrées</span></div></div>
  </div>

  <div class="filters-bar">
    <select (change)="onStatusFilter($event)" [value]="statusFilter()">
      <option value="all">Tous les statuts</option>
      <option value="en_attente">En attente</option>
      <option value="payee">Payées</option>
      <option value="en_preparation">En préparation</option>
      <option value="expediee">Expédiées</option>
      <option value="livree">Livrées</option>
      <option value="annulee">Annulées</option>
    </select>
  </div>

  <div class="commandes-list">
    @for (commande of filteredCommandes(); track commande.id) {
      <div class="commande-card" (click)="openDetail(commande)">
        <div class="commande-header">
          <span class="commande-numero">{{ commande.numeroCommande }}</span>
          <span class="commande-status" [class]="commande.statut">{{ getStatusLabel(commande.statut) }}</span>
        </div>
        <div class="commande-body">
          <div class="client-info">
            <span class="material-icons">person</span>
            <span>{{ commande.clientNom }}</span>
          </div>
          <div class="commande-meta">
            <span><span class="material-icons">calendar_today</span>{{ formatDate(commande.dateCommande) }}</span>
            <span><span class="material-icons">inventory_2</span>{{ commande.items.length }} article(s)</span>
          </div>
        </div>
        <div class="commande-footer">
          <span class="commande-total">{{ formatPrix(commande.total) }}</span>
          @if (getNextStatus(commande.statut)) {
            <button class="btn btn-primary btn-sm" (click)="updateStatus(commande, getNextStatus(commande.statut)!); $event.stopPropagation()">
              Passer en {{ getStatusLabel(getNextStatus(commande.statut)!) }}
            </button>
          }
        </div>
      </div>
    }
  </div>
</div>

@if (showDetail() && selectedCommande()) {
  <div class="modal-backdrop" (click)="closeDetail()"></div>
  <div class="modal modal-lg">
    <div class="modal-header">
      <h2>Commande {{ selectedCommande()!.numeroCommande }}</h2>
      <button class="close-btn" (click)="closeDetail()"><span class="material-icons">close</span></button>
    </div>
    <div class="modal-body">
      <div class="detail-section">
        <h3>Informations Client</h3>
        <div class="detail-grid">
          <div><label>Nom</label><span>{{ selectedCommande()!.clientNom }}</span></div>
          <div><label>Email</label><span>{{ selectedCommande()!.clientEmail }}</span></div>
          <div><label>Téléphone</label><span>{{ selectedCommande()!.clientTelephone }}</span></div>
          <div><label>Adresse</label><span>{{ selectedCommande()!.clientAdresse }}</span></div>
        </div>
      </div>
      <div class="detail-section">
        <h3>Articles Commandés</h3>
        <div class="items-list">
          @for (item of selectedCommande()!.items; track item.produitId) {
            <div class="item-row">
              <span class="item-name">{{ item.produitNom }}</span>
              <span class="item-qty">x{{ item.quantite }}</span>
              <span class="item-price">{{ formatPrix(item.prixUnitaire * item.quantite) }}</span>
            </div>
          }
        </div>
        <div class="total-row">
          <span>Total</span>
          <strong>{{ formatPrix(selectedCommande()!.total) }}</strong>
        </div>
      </div>
      <div class="detail-section">
        <h3>Statut</h3>
        <div class="status-timeline">
          @for (s of ['en_attente', 'payee', 'en_preparation', 'expediee', 'livree']; track s; let i = $index) {
            <div class="timeline-step" [class.active]="['en_attente', 'payee', 'en_preparation', 'expediee', 'livree'].indexOf(selectedCommande()!.statut) >= i" [class.current]="selectedCommande()!.statut === s">
              <span class="step-dot"></span>
              <span class="step-label">{{ getStatusLabel(s) }}</span>
            </div>
          }
        </div>
      </div>
    </div>
    <div class="modal-footer">
      @if (getNextStatus(selectedCommande()!.statut)) {
        <button class="btn btn-primary" (click)="updateStatus(selectedCommande()!, getNextStatus(selectedCommande()!.statut)!)">
          Passer en {{ getStatusLabel(getNextStatus(selectedCommande()!.statut)!) }}
        </button>
      }
    </div>
  </div>
}
