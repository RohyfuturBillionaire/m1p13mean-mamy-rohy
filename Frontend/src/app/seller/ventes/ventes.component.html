<div class="ventes-page">

  <!-- Header -->
  <div class="page-header">
    <div>
      <h1>Mes Ventes</h1>
      <p>Suivez vos performances et l'historique de vos ventes</p>
    </div>
    <a routerLink="/seller/commandes" class="btn btn-outline">
      <span class="material-icons">receipt_long</span>
      Gérer les commandes
    </a>
  </div>

  @if (loading()) {
    <div class="loading-state">
      <span class="material-icons spinning">refresh</span>
      <p>Chargement des données...</p>
    </div>
  } @else {

    <!-- KPI Grid -->
    <div class="kpi-grid">
      <div class="kpi-card" style="--accent: #6366F1">
        <div class="kpi-icon">
          <span class="material-icons">payments</span>
        </div>
        <div class="kpi-content">
          <span class="kpi-label">Revenu total</span>
          <span class="kpi-value">{{ formatMontant(totalRevenu()) }} Ar</span>
          <span class="kpi-sub">{{ formatPrix(totalRevenu()) }}</span>
        </div>
      </div>

      <div class="kpi-card" style="--accent: #10B981">
        <div class="kpi-icon">
          <span class="material-icons">shopping_cart</span>
        </div>
        <div class="kpi-content">
          <span class="kpi-label">Commandes</span>
          <span class="kpi-value">{{ nbCommandes() }}</span>
          <span class="kpi-sub">commandes passées</span>
        </div>
      </div>

      <div class="kpi-card" style="--accent: #F59E0B">
        <div class="kpi-icon">
          <span class="material-icons">shopping_basket</span>
        </div>
        <div class="kpi-content">
          <span class="kpi-label">Panier moyen</span>
          <span class="kpi-value">{{ formatMontant(panierMoyen()) }} Ar</span>
          <span class="kpi-sub">par commande</span>
        </div>
      </div>

      <div class="kpi-card" style="--accent: #8B5CF6">
        <div class="kpi-icon">
          <span class="material-icons">inventory_2</span>
        </div>
        <div class="kpi-content">
          <span class="kpi-label">Articles vendus</span>
          <span class="kpi-value">{{ totalArticlesVendus() }}</span>
          <span class="kpi-sub">unités écoulées</span>
        </div>
      </div>
    </div>

    <!-- Charts Row -->
    <div class="charts-row">

      <!-- Revenus mensuels -->
      <div class="chart-card large">
        <div class="card-header">
          <h3>Revenus Mensuels</h3>
          <span class="card-badge">{{ monthlyData().length }} mois</span>
        </div>

        @if (monthlyData().length === 0) {
          <div class="empty-chart">
            <span class="material-icons">bar_chart</span>
            <p>Aucune donnée disponible</p>
          </div>
        } @else {
          <div class="bar-chart">
            @for (m of monthlyData(); track $index; let i = $index) {
              <div class="bar-item">
                <div class="bar-wrapper">
                  <div
                    class="bar"
                    [style.height.%]="(m.revenu / maxRevenu()) * 100"
                    [style.background]="chartColors[i % chartColors.length]"
                  >
                    <span class="bar-tooltip">{{ formatMontant(m.revenu) }} Ar</span>
                  </div>
                </div>
                <span class="bar-label">{{ getMonthLabel(m) }}</span>
              </div>
            }
          </div>
        }
      </div>

      <!-- Top produits -->
      <div class="chart-card">
        <div class="card-header">
          <h3>Top Produits</h3>
          <a routerLink="/seller/produits" class="link">Voir tout</a>
        </div>

        @if (topBestSellers().length === 0) {
          <div class="empty-chart">
            <span class="material-icons">inventory_2</span>
            <p>Aucune vente enregistrée</p>
          </div>
        } @else {
          <div class="horizontal-bars">
            @for (p of topBestSellers(); track p._id; let i = $index) {
              <div class="h-bar-item">
                <div class="h-bar-label" [title]="p.nom">{{ p.nom }}</div>
                <div class="h-bar-wrapper">
                  <div
                    class="h-bar"
                    [style.width.%]="(p.totalVendu / maxVendu()) * 100"
                    [style.background]="chartColors[i % chartColors.length]"
                  ></div>
                  <span class="h-bar-value">{{ p.totalVendu }} vendus</span>
                </div>
                <span class="h-bar-revenu">{{ formatMontant(p.revenu) }} Ar</span>
              </div>
            }
          </div>
        }
      </div>
    </div>

    <!-- Historique des ventes -->
    <div class="ventes-section">
      <div class="section-header">
        <div>
          <h2>Historique des Ventes</h2>
          <p>{{ filteredCommandes().length }} vente{{ filteredCommandes().length > 1 ? 's' : '' }}</p>
        </div>
        <div class="filters">
          <select (change)="onStatusFilter($event)" [value]="statusFilter()">
            <option value="all">Tous les statuts</option>
            <option value="EN_ATTENTE">En attente</option>
            <option value="VALIDEE">Validées</option>
            <option value="EN_PREPARATION">En préparation</option>
            <option value="EXPEDIEE">Expédiées</option>
            <option value="LIVREE">Livrées</option>
            <option value="ANNULEE">Annulées</option>
          </select>
        </div>
      </div>

      @if (filteredCommandes().length === 0) {
        <div class="empty-state">
          <span class="material-icons">receipt_long</span>
          <p>Aucune vente trouvée</p>
        </div>
      } @else {
        <div class="ventes-table">
          <div class="table-header">
            <span>Commande</span>
            <span>Client</span>
            <span>Articles</span>
            <span>Date</span>
            <span>Statut</span>
            <span class="text-right">Montant</span>
          </div>

          @for (c of filteredCommandes(); track c._id) {
            <div class="table-row">
              <span class="commande-num">{{ c.numero_commande }}</span>

              <div class="client-cell">
                <div class="client-avatar">{{ (c.client_nom || 'C')[0].toUpperCase() }}</div>
                <div class="client-info">
                  <span class="client-name">{{ c.client_nom || '—' }}</span>
                  <span class="client-email">{{ c.client_email || '' }}</span>
                </div>
              </div>

              <div class="articles-cell">
                <span class="articles-count">{{ c.articles.length }} article{{ c.articles.length > 1 ? 's' : '' }}</span>
                <span class="articles-detail">{{ getArticlesPreview(c.articles) }}</span>
              </div>

              <span class="date-cell">{{ formatDate(c.date_commande) }}</span>

              <span class="status-badge" [class]="getStatusClass(c.status)">
                {{ getStatusLabel(c.status) }}
              </span>

              <span class="montant-cell">{{ formatPrix(c.total) }}</span>
            </div>
          }
        </div>
      }
    </div>

  }
</div>
