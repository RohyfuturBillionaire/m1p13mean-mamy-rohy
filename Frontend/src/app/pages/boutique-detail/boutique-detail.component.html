@if (loading()) {
  <div class="loading-state">
    <div class="loader"></div>
    <p>Chargement...</p>
  </div>
} @else if (boutique()) {
  <!-- Hero -->
  <section class="boutique-hero">
    <div class="hero-background">
      <img [src]="getLogoUrl(boutique()!)" [alt]="boutique()!.nom">
    </div>
    <div class="hero-overlay"></div>
    <div class="container">
      <div class="hero-content">
        <a routerLink="/boutiques" class="back-link">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m15 18-6-6 6-6"/>
          </svg>
          Retour aux boutiques
        </a>

        <div class="boutique-header">
          <div class="boutique-info">
            <span class="boutique-type">
              {{ boutique()!.type_boutique === 'restaurant' ? 'Restaurant' : boutique()!.type_boutique === 'service' ? 'Service' : 'Boutique' }}
            </span>
            <h1>{{ boutique()!.nom }}</h1>
            <p class="boutique-description">{{ boutique()!.description }}</p>

            <div class="boutique-meta">
              @if (boutique()!.id_categorie?.nom) {
                <div class="meta-item location">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                    <circle cx="12" cy="10" r="3"></circle>
                  </svg>
                  <span>{{ boutique()!.id_categorie.nom }}</span>
                </div>
              }
              @if (boutique()!.horaire_ouvert) {
                <div class="meta-item status open">
                  <span class="status-dot"></span>
                  <span>Horaires : {{ boutique()!.horaire_ouvert }}</span>
                </div>
              }
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Main Content -->
  <section class="boutique-main">
    <div class="container">
      <!-- Tabs -->
      <div class="tabs">
        <button
          class="tab"
          [class.active]="activeTab() === 'produits'"
          (click)="setTab('produits')"
        >
          Articles
          <span class="count">{{ articles().length }}</span>
        </button>
        <button
          class="tab"
          [class.active]="activeTab() === 'infos'"
          (click)="setTab('infos')"
        >
          Informations
        </button>
      </div>

      <!-- Tab Content -->
      <div class="tab-content">
        <!-- Produits Tab -->
        @if (activeTab() === 'produits') {
          <div class="produits-section">
            <!-- Search + Category Filters -->
            <div class="produit-toolbar">
              <div class="article-search-bar">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="11" cy="11" r="8"></circle>
                  <path d="m21 21-4.3-4.3"></path>
                </svg>
                <input
                  type="text"
                  [ngModel]="articleSearch()"
                  (ngModelChange)="articleSearch.set($event)"
                  placeholder="Rechercher un article..."
                  class="article-search-input"
                >
              </div>
              @if (articleCategories.length > 2) {
                <div class="produit-categories">
                  @for (cat of articleCategories; track cat) {
                    <button
                      class="category-btn"
                      [class.active]="selectedCategorie() === cat"
                      (click)="setCategorie(cat)"
                    >
                      {{ cat === 'all' ? 'Tout' : cat }}
                    </button>
                  }
                </div>
              }
            </div>

            @if (filteredArticles().length === 0 && (articleSearch() || selectedCategorie() !== 'all')) {
              <div class="no-results"><p>Aucun article ne correspond Ã  votre recherche.</p></div>
            }

            <!-- Products Grid -->
            <div class="produits-grid">
              @for (article of filteredArticles(); track article._id) {
                <article class="produit-card">
                  <div class="produit-image">
                    <img [src]="getArticleImage(article)" [alt]="article.nom" loading="lazy">
                    <button
                      class="favorite-btn"
                      [class.is-favorite]="isFavorite(article._id)"
                      (click)="toggleFavorite(article._id); $event.stopPropagation()"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                        [attr.fill]="isFavorite(article._id) ? '#EF4444' : 'none'"
                        [attr.stroke]="isFavorite(article._id) ? '#EF4444' : 'currentColor'"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                      </svg>
                    </button>
                  </div>
                  <div class="produit-content">
                    @if (article.id_categorie_article?.nom) {
                      <span class="produit-category">{{ article.id_categorie_article.nom }}</span>
                    }
                    <h4>{{ article.nom }}</h4>
                    <app-star-rating
                      [note]="getArticleRating(article._id).moyenne"
                      [count]="getArticleRating(article._id).count"
                      [interactive]="true"
                      [size]="14"
                      (rated)="rateArticle(article._id, $event)"
                    ></app-star-rating>
                    <p>{{ article.description }}</p>
                    <div class="produit-footer">
                      <div class="produit-prix">
                        @if (getPromoRemise(article._id) > 0) {
                          <span class="prix-original">{{ formatPrix(article.prix) }}</span>
                          <span class="prix-promo">{{ formatPrix(getPrixPromo(article)) }}</span>
                          <span class="promo-badge-sm">-{{ getPromoRemise(article._id) }}%</span>
                        } @else {
                          <span class="prix">{{ formatPrix(article.prix) }}</span>
                        }
                      </div>
                      <button
                        class="add-to-cart-btn"
                        [class.added]="addedToCart() === article._id"
                        [class.in-cart]="isInCart(article._id)"
                        (click)="addToCart(article)"
                      >
                        @if (addedToCart() === article._id) {
                          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                          </svg>
                          Ajoute
                        } @else if (isInCart(article._id)) {
                          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="9" cy="21" r="1"></circle>
                            <circle cx="20" cy="21" r="1"></circle>
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                          </svg>
                          Dans le panier
                        } @else {
                          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="9" cy="21" r="1"></circle>
                            <circle cx="20" cy="21" r="1"></circle>
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                          </svg>
                          Ajouter
                        }
                      </button>
                    </div>
                  </div>
                </article>
              }
            </div>

            @if (articles().length === 0) {
              <div class="no-results">
                <p>Aucun article disponible pour cette boutique.</p>
              </div>
            }
          </div>
        }

        <!-- Infos Tab -->
        @if (activeTab() === 'infos') {
          <div class="infos-section">
            <div class="infos-grid">
              <!-- Description -->
              <div class="info-card description-card">
                <h3>A propos</h3>
                <p>{{ boutique()!.description }}</p>
              </div>

              <!-- Horaires -->
              @if (boutique()!.horaire_ouvert) {
                <div class="info-card">
                  <h3>Horaires d'ouverture</h3>
                  <p>{{ boutique()!.horaire_ouvert }}</p>
                </div>
              }

              <!-- Contact -->
              <div class="info-card">
                <h3>Contact</h3>
                <ul class="contact-list">
                  @if (boutique()!.email) {
                    <li>
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                        <polyline points="22,6 12,13 2,6"></polyline>
                      </svg>
                      <a href="mailto:{{ boutique()!.email }}">{{ boutique()!.email }}</a>
                    </li>
                  }
                  @if (boutique()!.reseau) {
                    <li>
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="2" y1="12" x2="22" y2="12"></line>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                      </svg>
                      <span>{{ boutique()!.reseau }}</span>
                    </li>
                  }
                </ul>
              </div>

              <!-- Categorie -->
              @if (boutique()!.id_categorie?.nom) {
                <div class="info-card">
                  <h3>Categorie</h3>
                  <p>{{ boutique()!.id_categorie.nom }}</p>
                </div>
              }
            </div>
          </div>
        }
      </div>
    </div>
  </section>
} @else {
  <div class="not-found">
    <div class="container">
      <h2>Boutique non trouvee</h2>
      <p>La boutique que vous recherchez n'existe pas ou a ete supprimee.</p>
      <a routerLink="/boutiques" class="btn btn-primary">Voir toutes les boutiques</a>
    </div>
  </div>
}
