<div class="checkout-page">
  <div class="container">
    <!-- Header -->
    <div class="checkout-header">
      <a routerLink="/boutiques" class="back-link">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="m15 18-6-6 6-6"/>
        </svg>
        Retour aux boutiques
      </a>
      <h1>Finaliser ma commande</h1>
      <p>Vérifiez votre panier et complétez vos informations</p>
    </div>

    @if (isEmpty()) {
      <div class="empty-cart">
        <div class="empty-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="9" cy="21" r="1"></circle>
            <circle cx="20" cy="21" r="1"></circle>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
          </svg>
        </div>
        <h2>Votre panier est vide</h2>
        <p>Ajoutez des produits à votre panier avant de passer commande</p>
        <a routerLink="/boutiques" class="btn btn-primary">
          Découvrir nos boutiques
        </a>
      </div>
    } @else {
      <div class="checkout-layout">
        <!-- Left Column - Form -->
        <div class="checkout-form-section">
          <!-- Customer Information -->
          <div class="checkout-card">
            <h2>
              <span class="step-number">1</span>
              Informations de contact
            </h2>
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label" for="prenom">Prénom *</label>
                <input
                  type="text"
                  id="prenom"
                  [(ngModel)]="clientInfo.prenom"
                  class="form-input"
                  placeholder="Votre prénom"
                  required
                >
              </div>
              <div class="form-group">
                <label class="form-label" for="nom">Nom *</label>
                <input
                  type="text"
                  id="nom"
                  [(ngModel)]="clientInfo.nom"
                  class="form-input"
                  placeholder="Votre nom"
                  required
                >
              </div>
              <div class="form-group">
                <label class="form-label" for="email">Email *</label>
                <input
                  type="email"
                  id="email"
                  [(ngModel)]="clientInfo.email"
                  class="form-input"
                  placeholder="exemple@email.com"
                  required
                >
              </div>
              <div class="form-group">
                <label class="form-label" for="telephone">Téléphone *</label>
                <input
                  type="tel"
                  id="telephone"
                  [(ngModel)]="clientInfo.telephone"
                  class="form-input"
                  placeholder="+261 34 00 000 00"
                  required
                >
              </div>
              <div class="form-group full-width">
                <label class="form-label" for="adresse">Adresse *</label>
                <input
                  type="text"
                  id="adresse"
                  [(ngModel)]="clientInfo.adresse"
                  class="form-input"
                  placeholder="Lot, rue, quartier..."
                  required
                >
              </div>
              <div class="form-group">
                <label class="form-label" for="ville">Ville</label>
                <input
                  type="text"
                  id="ville"
                  [(ngModel)]="clientInfo.ville"
                  class="form-input"
                  placeholder="Antananarivo"
                >
              </div>
              <div class="form-group">
                <label class="form-label" for="codePostal">Code Postal</label>
                <input
                  type="text"
                  id="codePostal"
                  [(ngModel)]="clientInfo.codePostal"
                  class="form-input"
                  placeholder="101"
                >
              </div>
            </div>
          </div>

          <!-- Payment Method -->
          <div class="checkout-card">
            <h2>
              <span class="step-number">2</span>
              Mode de paiement
            </h2>
            <div class="payment-methods">
              @for (method of paymentMethods; track method.id) {
                <label
                  class="payment-method"
                  [class.selected]="selectedPaymentMethod === method.id"
                >
                  <input
                    type="radio"
                    name="paymentMethod"
                    [value]="method.id"
                    [(ngModel)]="selectedPaymentMethod"
                    class="payment-radio"
                  >
                  <div class="payment-content">
                    <span class="material-icons payment-icon">{{ method.icon }}</span>
                    <div class="payment-info">
                      <span class="payment-name">{{ method.name }}</span>
                      <span class="payment-description">{{ method.description }}</span>
                    </div>
                  </div>
                  <span class="payment-check">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                  </span>
                </label>
              }
            </div>
          </div>
        </div>

        <!-- Right Column - Summary -->
        <div class="checkout-summary-section">
          <div class="checkout-card summary-card">
            <h2>Récapitulatif</h2>

            <!-- Cart Items -->
            <div class="summary-items">
              @for (item of items(); track item.produit.id + item.boutiqueId) {
                <div class="summary-item">
                  <div class="item-image">
                    <img [src]="item.produit.image" [alt]="item.produit.nom">
                    <span class="item-quantity">{{ item.quantite }}</span>
                  </div>
                  <div class="item-info">
                    <span class="item-boutique">{{ item.boutiqueNom }}</span>
                    <span class="item-name">{{ item.produit.nom }}</span>
                  </div>
                  <span class="item-total">{{ formatPrix(getItemTotal(item)) }}</span>
                </div>
              }
            </div>

            <!-- Totals -->
            <div class="summary-totals">
              <div class="total-row">
                <span>Sous-total</span>
                <span>{{ formatPrix(sousTotal()) }}</span>
              </div>
              <div class="total-row">
                <span>TVA (20%)</span>
                <span>{{ formatPrix(tva()) }}</span>
              </div>
              <div class="total-row shipping">
                <span>Livraison</span>
                <span class="free">Gratuit</span>
              </div>
              <div class="total-row grand-total">
                <span>Total</span>
                <span>{{ formatPrix(total()) }}</span>
              </div>
            </div>

            <!-- Pay Button -->
            <button
              class="pay-btn"
              [disabled]="!isFormValid() || isProcessing()"
              (click)="processPayment()"
            >
              @if (isProcessing()) {
                <span class="loader-sm"></span>
                Traitement en cours...
              } @else {
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                  <line x1="1" y1="10" x2="23" y2="10"></line>
                </svg>
                Payer {{ formatPrix(total()) }}
              }
            </button>

            <p class="security-note">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
              </svg>
              Paiement sécurisé
            </p>
          </div>
        </div>
      </div>
    }
  </div>
</div>

<!-- Success Modal -->
@if (showSuccessModal()) {
  <div class="modal-backdrop" (click)="closeModal()"></div>
  <div class="success-modal">
    <div class="modal-content">
      <div class="success-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
      </div>
      <h2>Paiement réussi !</h2>
      <p>Votre commande <strong>{{ currentOrder()?.numeroCommande }}</strong> a été confirmée.</p>
      <p class="email-note">Un email de confirmation a été envoyé à {{ clientInfo.email }}</p>
      <div class="modal-actions">
        <button class="btn btn-primary" (click)="goToInvoice()">
          Voir ma facture
        </button>
        <button class="btn btn-secondary" (click)="goToHome()">
          Retour à l'accueil
        </button>
      </div>
    </div>
  </div>
}
