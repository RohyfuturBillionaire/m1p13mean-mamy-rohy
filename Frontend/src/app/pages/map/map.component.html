<!-- Page Header -->
<section class="page-header">
  <!-- <div class="container">
    <div class="header-content">
      <div class="header-left">
        <button class="menu-btn">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
      <div class="header-center">
        <h1>Tana Center</h1>
        <p>Votre centre commercial</p>
      </div>
      <div class="header-right">
        <div class="status-badge open">
          <span class="status-text">OUVERT</span>
          <span class="status-time">Ferme à 21:00</span>
        </div>
      </div>
    </div>
  </div> -->
</section>

<!-- Map Section -->
<section class="map-section">
  <div class="container">
    <!-- Floor Tabs -->
    <div class="floor-tabs">
      @for (etage of etages(); track etage) {
        <button
          class="floor-tab"
          [class.active]="selectedEtage() === etage"
          (click)="setEtage(etage)"
        >
          {{ etage === 1 ? '1er' : etage + 'ème' }} étage
        </button>
      }
    </div>

    <!-- Floor Title -->
    <div class="floor-title">
      <h2>{{ selectedEtage() === 1 ? '1er' : selectedEtage() + 'ème' }} étage</h2>
      <div class="title-underline"></div>
    </div>

    <!-- Map Container -->
    <div class="map-container">
      <!-- Floor Plan Grid -->
      <div class="floor-plan">
        <!-- Row 1 -->
        <div class="plan-row">
          @for (local of locauxEtage(); track local._id) {
            @if (local.y === 1) {
              <button
                class="shop-block"
                [class.active]="selectedLocal()?._id === local._id"
                [class.hovered]="hoveredLocal() === local._id"
                [class.libre]="isLibre(local)"
                [style.background]="getLocalColor(local)"
                [style.grid-column]="'span ' + local.largeur"
                [style.grid-row]="'span ' + local.hauteur"
                (click)="selectLocal(local)"
                (mouseenter)="setHoveredLocal(local._id)"
                (mouseleave)="setHoveredLocal(null)"
              >
                <span class="shop-name">{{ getLocalLabel(local) }}</span>
                @if (isLibre(local)) {
                  <span class="shop-libre">LIBRE</span>
                }
              </button>
            }
          }
        </div>

        <!-- Central Zone -->
        <div class="plan-center">
          <div class="plan-row side-left">
            @for (local of locauxEtage(); track local._id) {
              @if (local.y === 2 && local.x <= 2) {
                <button
                  class="shop-block"
                  [class.active]="selectedLocal()?._id === local._id"
                  [class.hovered]="hoveredLocal() === local._id"
                  [class.libre]="isLibre(local)"
                  [style.background]="getLocalColor(local)"
                  (click)="selectLocal(local)"
                  (mouseenter)="setHoveredLocal(local._id)"
                  (mouseleave)="setHoveredLocal(null)"
                >
                  <span class="shop-name">{{ getLocalLabel(local) }}</span>
                  @if (isLibre(local)) {
                    <span class="shop-libre">LIBRE</span>
                  }
                </button>
              }
            }
          </div>

          <!-- Allée centrale -->
          <div class="central-aisle">
            <div class="escalator-zone">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="18 15 12 9 6 15"></polyline>
              </svg>
              <span>Escalators</span>
            </div>
            <div class="aisle-arrow">
              <span>&#8592;</span>
              <span class="aisle-text">Food Court & Services</span>
            </div>
          </div>

          <div class="plan-row side-right">
            @for (local of locauxEtage(); track local._id) {
              @if (local.y === 2 && local.x > 2) {
                <button
                  class="shop-block"
                  [class.active]="selectedLocal()?._id === local._id"
                  [class.hovered]="hoveredLocal() === local._id"
                  [class.libre]="isLibre(local)"
                  [style.background]="getLocalColor(local)"
                  (click)="selectLocal(local)"
                  (mouseenter)="setHoveredLocal(local._id)"
                  (mouseleave)="setHoveredLocal(null)"
                >
                  <span class="shop-name">{{ getLocalLabel(local) }}</span>
                  @if (isLibre(local)) {
                    <span class="shop-libre">LIBRE</span>
                  }
                </button>
              }
            }
          </div>
        </div>

        <!-- Row 3 -->
        <div class="plan-row bottom-row">
          @for (local of locauxEtage(); track local._id) {
            @if (local.y === 3) {
              <button
                class="shop-block"
                [class.active]="selectedLocal()?._id === local._id"
                [class.hovered]="hoveredLocal() === local._id"
                [class.libre]="isLibre(local)"
                [style.background]="getLocalColor(local)"
                (click)="selectLocal(local)"
                (mouseenter)="setHoveredLocal(local._id)"
                (mouseleave)="setHoveredLocal(null)"
              >
                <span class="shop-name">{{ getLocalLabel(local) }}</span>
                @if (isLibre(local)) {
                  <span class="shop-libre">LIBRE</span>
                }
              </button>
            }
          }

          <!-- WC et autres services -->
          <div class="service-block wc">
            <span>WC</span>
          </div>
        </div>
      </div>

      <!-- Map Legend -->
      <div class="map-legend">
        @for (item of legendItems(); track item.label) {
          <div class="legend-item">
            <span class="legend-dot" [style.background]="item.color"></span>
            <span class="legend-label">{{ item.label }}</span>
          </div>
        }
      </div>
    </div>

    <!-- Selected Local Info -->
    @if (selectedLocal()) {
      <div class="boutique-info-card">
        <button class="close-btn" (click)="closeLocalInfo()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
        <div class="info-header">
          @if (selectedLocal()!.id_boutique?.logo) {
            <img [src]="getLogoUrl(selectedLocal()!)" [alt]="selectedLocal()!.id_boutique?.nom" class="info-image">
          } @else {
            <div class="info-image-placeholder">
              <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
              </svg>
            </div>
          }
          <div class="info-content">
            <span class="info-type" [style.background]="getLocalColor(selectedLocal()!)">
              {{ selectedLocal()!.statut === 'OCCUPE' ? 'Occupé' : 'Libre' }}
            </span>
            <h3>{{ selectedLocal()!.id_boutique?.nom || ('Local ' + selectedLocal()!.numero) }}</h3>
            <p>{{ selectedLocal()!.id_boutique?.description || 'Espace commercial disponible' }}</p>
          </div>
        </div>
        <div class="info-details">
          <div class="detail-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
            <span>Local {{ selectedLocal()!.numero }} — Étage {{ selectedLocal()!.etage }}</span>
          </div>
          @if (selectedLocal()!.id_boutique?.type_boutique) {
            <div class="detail-item">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
              </svg>
              <span>{{ selectedLocal()!.id_boutique.type_boutique }}</span>
            </div>
          }
        </div>
        @if (selectedLocal()!.id_boutique) {
          <a [routerLink]="['/boutique', selectedLocal()!.id_boutique._id]" class="btn btn-primary">
            Voir la boutique
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="5" y1="12" x2="19" y2="12"></line>
              <polyline points="12 5 19 12 12 19"></polyline>
            </svg>
          </a>
        }
      </div>
    }
  </div>
</section>
